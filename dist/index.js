import ra from"colors";import ta from"mongoose";import oa from"connect-mongo";import x from"mongoose";import{config as J}from"dotenv";import L from"colors";import A from"bcrypt";import P from"mongoose";P.Promise=global.Promise;var g=new P.Schema({email:{type:String,unique:!0,lowercase:!0,trim:!0},nombre:{type:String,required:"Agrega un nombre"},password:{type:String,required:!0,trim:!0},token:String,expiracion:Date,imagen:String,confirmarCuenta:{type:Number,default:0}});g.pre("save",async function(e){if(!this.isModified("password"))return e();this.password=await A.hash(this.password,12),e()});g.post("save",function(e,a,r){e.name==="MongoError"&&e.code===11e3?r("No puedes registrarte con este correo, ya esta en uso"):r(e)});g.methods={compararPassword:function(e){return A.compareSync(e,this.password)}};var ka=P.model("Usuarios",g);import v from"mongoose";import F from"slug";import N from"shortid";v.Promise=global.Promise;var E=new v.Schema({titulo:{type:String,trim:!0},empresa:{type:String,trim:!0},ubicacion:{type:String,trim:!0},salario:{type:String,default:0,trim:!0},contrato:{type:String,trim:!0},descripcion:{type:String,trim:!0},url:{type:String,lowercase:!0},skills:[String],candidatos:[{nombre:{type:String,uppercase:!0},email:String,cv:String}],autor:{type:v.Schema.ObjectId,ref:"Usuarios"}});E.pre("save",function(e){let a=F(this.titulo);this.url=`${a}-${N.generate()}`,e()});E.index({titulo:"text"});var La=v.model("Vacante",E);J({path:"variables.env"});x.set("strictQuery",!1);x.connect(process.env.DATABASE,{useNewUrlParser:!0});x.connection.on("connected",e=>{console.log(e?L.red("No se pudo conectar a la base de datos",e):L.green("Servidor conectado a la base de datos correctamente"))});import f from"express";import qe from"express";import H from"mongoose";var Q=H.model("Vacante"),G=async(e,a,r)=>{let t=await Q.find().lean();if(!t)return r();a.render("home",{tituloPagina:"Plataforma de Empleo Devs",tagLine:"Plataforma para subir y encontrar trabajos para Desarrollares Web",barra:!0,boton:!0,vacantes:t})},z=G;import te from"mongoose";var d={host:"sandbox.smtp.mailtrap.io",port:2525,auth:{user:"ee04cbd260a961",pass:"05a72070612c87"}};import W from"nodemailer";import Z from"nodemailer-express-handlebars";import K from"util";import{fileURLToPath as Y}from"url";import X,{dirname as q}from"path";var ee=q(Y(import.meta.url)),b=W.createTransport({host:d.host,port:d.port,auth:{user:d.auth.user,pass:d.auth.pass}}),ae=X.join(ee,"/../views/email");b.use("compile",Z({viewEngine:{defaultLayout:!1},viewPath:ae,extName:".handlebars"}));var re=async e=>{let a={from:"plataformaDevJob@hotmail.com",to:e.usuario.email,subject:e.subject,template:e.archivo,context:{resetUrl:e.resetUrl,validarCuenta:e.validarCuenta}};return K.promisify(b.sendMail,b).call(b,a)},h=re;var p=te.model("Usuarios"),oe=(e,a)=>{a.render("crear-cuenta",{tituloPagina:"Crea tu cuenta en DevJobs",tagLine:"Publica tus vacantes, crea una cuenta y empieza ya!"})},ie=async(e,a)=>{let r=new p(e.body),{email:t}=r;try{await r.save();let o=`http://${e.headers.host}/verificar-cuenta/${t}`,c=await p.findOne({email:t});await h({usuario:c,subject:"Confirma tu cuenta, por favor",validarCuenta:o,archivo:"confirmar-cuenta"}),e.flash("correcto","Valida tu cuenta en el correo electronico con el que te haz registrado"),a.redirect("/iniciar-sesion")}catch(o){e.flash("error",o.message),a.redirect("/crear-cuenta")}},se=async(e,a)=>{let r=await p.findOne({email:e.params.email});r?(r.confirmarCuenta=1,r.save(),e.flash("correcto","Tu cuenta se ha validado correctamente"),a.redirect("/iniciar-sesion")):(e.flash("error","Hubo un error en la validacion de la cuenta"),a.redirect("/crear-cuenta"))},ne=async(e,a,r)=>{let{email:t}=e.body,o=await p.findOne({email:t});if(!o){e.flash("error","El email introducido no esta registrado"),a.redirect("/crear-cuenta");return}if(o.confirmarCuenta===0){e.flash("error","Debes confirmar tu cuenta para iniciar sesion"),a.redirect("/iniciar-sesion");return}r()},ce=(e,a)=>{a.render("iniciar-sesion",{tituloPagina:"Iniciar Sesion en DevJobs"})},ue=(e,a)=>{let r=e.user,{nombre:t,imagen:o}=e.user;a.render("editar-perfil",{tituloPagina:"Edita tu perfil en DevJobs",usuario:r,cerrarSesion:!0,nombre:t,imagen:o})},le=async(e,a)=>{let{_id:r}=e.user,t=await p.findById(r),{nombre:o,email:c,password:m}=e.body;t.nombre=o,t.email=c,m&&(t.password=m),e.file&&(t.imagen=e.file.filename),await t.save(),e.flash("correcto","Cambios guardados correctamente"),a.redirect("/administracion")},u={formCrearUsuario:oe,crearCuentaUsuario:ie,formIniciarSesion:ce,editarPerfil:le,formEditarPerfil:ue,confirmarCuenta:se,verificarCuenta:ne};import me from"mongoose";import C from"multer";import de from"shortid";import{fileURLToPath as pe}from"url";import fe,{dirname as ge}from"path";var l=me.model("Vacante"),ve=ge(pe(import.meta.url)),be=(e,a)=>{a.render("nueva-vacante",{tituloPagina:"Nueva Vacante",tagLine:"Llena el formulario y publica tu vacante",cerrarSesion:!0,nombre:e.user.nombre,imagen:e.user.imagen})},he=async(e,a)=>{let r=new l(e.body);r.autor=e.user._id,r.skills=e.body.skills.split(",");try{await r.save(),a.redirect("/")}catch{a.flash("error","Hubo un error al crear la vacante"),a.redirect("/")}},ye=async(e,a,r)=>{let{url:t}=e.params,o=await l.findOne({url:t}).populate("autor");o||r(),a.render("vacante",{tituloPagina:o.titulo,barra:!0,vacante:o})},we=async(e,a,r)=>{let{url:t}=e.params,o=await l.findOne({url:t});o||r(),a.render("editar-vacante",{vacante:o,tituloPagina:`Editar Vacante - ${o.titulo}`,cerrarSesion:!0,nombre:e.user.nombre,imagen:e.user.imagen})},Se=async(e,a,r)=>{let{body:t}=e,{url:o}=e.params;t.skills=t.skills.split(",");let c=await l.findOneAndUpdate({url:o},t,{new:!0,runValidators:!0});c||r(),a.redirect(`/vacantes/${c.url}`)},Pe=async(e,a)=>{let{id:r}=e.params,t=await l.findById(r);Ee(t,e.user)?(t.remove(),a.status(200).send("Vacante eliminada correctamente")):a.status(403).send("Error")},Ee=(e={},a={})=>!!e.autor.equals(a._id),xe=(e,a,r)=>{Ue(e,a,t=>{if(t){t instanceof C.MulterError&&t.code==="LIMIT_FILE_SIZE"?e.flash("error","El archivo es muy grande"):e.flash("error",t.message),a.redirect("back");return}else return r()})},Ce=fe.join(ve,"../public/uploads/cv"),ke={limits:{fileSize:5e5},storage:C.diskStorage({destination:(e,a,r)=>{r(null,Ce)},filename:(e,a,r)=>{let t=a.mimetype.split("/")[1];r(null,`${de.generate()}.${t}`)}}),fileFilter(e,a,r){a.mimetype==="application/pdf"?r(null,!0):r(new Error("Formato de archivo no valido."),!1)}},Ue=C(ke).single("cv"),Ve=async(e,a,r)=>{let t=await l.findOne({url:e.params.url});if(!t)return r();let o={nombre:e.body.nombre,email:e.body.email,cv:e.file.filename};t.candidatos.push(o),await t.save(),e.flash("correcto","Se envio tu Cv correctamente"),a.redirect("/")},Be=async(e,a,r)=>{let{id:t}=e.params,{nombre:o,imagen:c}=e.user,m=await l.findById(t),{candidatos:M}=m;if(m.autor!=e.user._id.toString()||!m)return r();a.render("candidatos",{tituloPagina:`Candidatos Vacante - ${m.titulo}`,cerrarSesion:!0,nombre:o,imagen:c,candidatos:M})},Ae=async(e,a)=>{let{query:r}=e.body,t=await l.find({$text:{$search:r}});a.render("home",{tituloPagina:`Resultados para la busqueda: ${r}`,barra:!0,vacantes:t})},n={formNuevaVacante:be,agregarVacante:he,findVacanteUrl:ye,formEditarVacante:we,actualizarVacante:Se,eliminarVacante:Pe,subirCurriculum:xe,contactar:Ve,mostrarCandidatos:Be,buscarVacantesInput:Ae};var Le=(e,a,r)=>{let{password:t}=e.body;e.sanitizeBody("nombre").escape(),e.sanitizeBody("email").escape(),e.sanitizeBody("password").escape(),e.sanitizeBody("confirmarPassword").escape(),e.checkBody("nombre","Nombre es un campo obligatorio").notEmpty(),e.checkBody("email","Email es un campo obligatorio y valido").isEmail(),e.checkBody("password","Password es un campo obligatorio").notEmpty(),e.checkBody("confirmarPassword","Repetir Password es un campo obligatorio").notEmpty(),e.checkBody("confirmarPassword","Las contrase\xF1as no coinciden").equals(t);let o=e.validationErrors();if(!o)return r();e.flash("error",o.map(c=>c.msg)),a.render("crear-cuenta",{tituloPagina:"Crea tu cuenta en DevJobs",tagLine:"Publica tus vacantes gratis,crea una cuenta y empieza ya!",mensajes:e.flash()})},j=Le;var ze=(e,a,r)=>{e.sanitizeBody("titulo").escape(),e.sanitizeBody("empresa").escape(),e.sanitizeBody("ubicacion").escape(),e.sanitizeBody("salario").escape(),e.sanitizeBody("contrato").escape(),e.sanitizeBody("skills").escape(),e.checkBody("titulo","Agrega un nombre a la vacante").notEmpty(),e.checkBody("empresa","Agrega una empresa").notEmpty(),e.checkBody("ubicacion","Agrega una ubicacion").notEmpty(),e.checkBody("contrato","Seleccion un tipo de contrato").notEmpty(),e.checkBody("skills","Seleccion al menos una habilidad").notEmpty();let t=e.validationErrors();if(!t)return r();e.flash("error",t.map(o=>o.msg)),a.render("nueva-vacante",{tituloPagina:"Nueva vacante",tagLine:"Publica tus vacantes rellenando el formulario",mensajes:e.flash()})},k=ze;var je=(e,a,r)=>{e.sanitizeBody("nombre").escape(),e.sanitizeBody("email").escape(),e.body.password&&e.sanitizeBody("password").escape(),e.checkBody("nombre","El nombre no puede ir vacio"),e.checkBody("email","El email no puede ir vacio");let t=e.validationErrors();if(!t)return r();e.flash("error",t.map(o=>o.msg)),a.render("editar-perfil",{tituloPagina:"Edita tu perfil en DevJobs",usuario,cerrarSesion:!0,nombre:e.user.nombre,imagen:e.user.imagen,mensajes:e.flash()})},$=je;import $e from"passport";import R from"mongoose";import De from"crypto";var Re=R.model("Vacante"),U=R.model("Usuarios"),Ie=$e.authenticate("local",{successRedirect:"/administracion",failureRedirect:"/iniciar-sesion",failureFlash:!0,badRequestMessage:"Ambos campos son obligatorios"}),Te=(e,a,r)=>{if(e.isAuthenticated())return r();a.redirect("/iniciar-sesion")},_e=async(e,a)=>{let r=await Re.find({autor:e.user._id}).lean();a.render("administracion",{tituloPagina:"Administracion",tagLine:"Crear y administra tus vacantes desde aqui",vacantes:r,cerrarSesion:!0,nombre:e.user.nombre,imagen:e.user.imagen})},Oe=(e,a,r)=>{e.logout(t=>t?r(t):(e.flash("correcto","Sesion Cerrada Correctamente"),a.redirect("/iniciar-sesion")))},Me=(e,a)=>{a.render("reestablecer-password",{tituloPagina:"Reestablece tu password",tagLine:"Si ya tienes cuenta, y olvidastes tu contrase\xF1a, reestablecela"})},Fe=async(e,a)=>{let r=await U.findOne({email:e.body.email});if(!r)return e.flash("error","El email no existe"),a.redirect("/reestablecer-password");r.token=De.randomBytes(20).toString("hex"),r.expiracion=Date.now()+72e5,await r.save();let t=`http://${e.headers.host}/reestablecer-password/${r.token}`;await h({usuario:r,subject:"Reestablecimiento de contrase\xF1a",resetUrl:t,archivo:"reset-password"}),e.flash("correcto","Revisa tu email, para reestablecer la contrase\xF1a"),a.redirect("/iniciar-sesion")},Ne=async(e,a)=>{let{token:r}=e.params;await U.findOne({token:r,expiracion:{$gt:Date.now()}})||e.flash("error","El tiempo para reestablecer la contrase\xF1a, expir\xF3"),a.render("nueva-contrase\xF1a",{tituloPagina:"Reestablece tu nueva password",tagLine:"Escribe tu nueva contrase\xF1a,para cambiarla"})},Je=async(e,a)=>{let{token:r}=e.params,{password:t}=e.body,o=await U.findOne({token:r,expiracion:{$gt:Date.now()}});o||e.flash("error","El tiempo para reestablecer la contrase\xF1a, expir\xF3"),o.password=t,o.token=void 0,o.expiracion=void 0,await o.save(),e.flash("correcto","La contrase\xF1a ha sido actualiada correctamente"),a.redirect("/iniciar-sesion")},s={autenticarUsuario:Ie,mostrarPanelAdministracion:_e,usuarioAutenticado:Te,cerrarSesion:Oe,reestablecerPasswordForm:Me,reestablecerPassword:Fe,verificarToken:Ne,cambiarPassword:Je};import V from"multer";import He from"shortid";import{fileURLToPath as Qe}from"url";import Ge,{dirname as We}from"path";var Ze=We(Qe(import.meta.url)),D=(e,a,r)=>{Xe(e,a,t=>{if(t){t instanceof V.MulterError&&t.code==="LIMIT_FILE_SIZE"?e.flash("error","El archivo es muy grande"):e.flash("error",t.message),a.redirect("/administracion");return}else return r()})},Ke=Ge.join(Ze,"../public/uploads/perfiles"),Ye={limits:{fileSize:1e5},storage:V.diskStorage({destination:(e,a,r)=>{r(null,Ke)},filename:(e,a,r)=>{let t=a.mimetype.split("/")[1];r(null,`${He.generate()}.${t}`)}}),fileFilter(e,a,r){a.mimetype==="image/jpeg"||a.mimetype==="image/png"?r(null,!0):r(new Error("Formato de archivo no valido."),!1)}},Xe=V(Ye).single("imagen");var I=qe.Router();I.get("/",z).get("/vacantes/nueva",s.usuarioAutenticado,n.formNuevaVacante).post("/vacantes/nueva",s.usuarioAutenticado,k,n.agregarVacante).get("/vacantes/:url",n.findVacanteUrl).get("/vacantes/editar/:url",s.usuarioAutenticado,n.formEditarVacante).post("/vacantes/editar/:url",s.usuarioAutenticado,k,n.actualizarVacante).delete("/vacantes/eliminar/:id",n.eliminarVacante).get("/crear-cuenta",u.formCrearUsuario).post("/crear-cuenta",j,u.crearCuentaUsuario).get("/iniciar-sesion",u.formIniciarSesion).post("/iniciar-sesion",u.verificarCuenta,s.autenticarUsuario).get("/cerrar-sesion",s.usuarioAutenticado,s.cerrarSesion).get("/verificar-cuenta/:email",u.confirmarCuenta).get("/reestablecer-password",s.reestablecerPasswordForm).post("/reestablecer-password",s.reestablecerPassword).get("/reestablecer-password/:token",s.verificarToken).post("/reestablecer-password/:token",s.cambiarPassword).get("/administracion",s.usuarioAutenticado,s.mostrarPanelAdministracion).get("/editar-perfil",s.usuarioAutenticado,u.formEditarPerfil).post("/editar-perfil",s.usuarioAutenticado,$,D,u.editarPerfil).post("/vacantes/:url",n.subirCurriculum,n.contactar).get("/candidatos/:id",s.usuarioAutenticado,n.mostrarCandidatos).post("/buscador",n.buscarVacantesInput);var T=I;import ia from"handlebars";import sa from"express-handlebars";import{allowInsecurePrototypeAccess as na}from"@handlebars/allow-prototype-access";import{config as ca}from"dotenv";import ua from"cookie-parser";import la from"express-session";var _={seleccionarSkills:(e=[],a)=>{let r=["HTML5","CSS","Apollo","Node","React JS","CSSGRID","FlexBox","JavaScript","React Hooks","Redux","GraphQL","TypeScript","Django","ORM","Sass","Laravel","Sequelize","Mongoose","SQL","MVC","PHP","Phyton","VueJs","Angular","WordPress"],t="";return r.forEach(o=>{t+=`<li ${e.includes(o)?'class="activo"':""}>${o}</li>`}),a.fn=t},tipoContrato:(e,a)=>a.fn(void 0).replace(new RegExp(`value="${e}"`),'$& selected="selected"'),mostrarAlertas:(e={},a)=>{let r=Object.keys(e),t="";return r.length&&e[r].forEach(o=>{t+=`<div class="${r} alerta"> ${o}</div>`}),a.fn=t}};import{fileURLToPath as ma}from"url";import w,{dirname as da}from"path";import pa from"express-validator";import fa from"connect-flash";import y from"passport";import{Strategy as ea}from"passport-local";import aa from"mongoose";var O=aa.model("Usuarios");y.use(new ea({usernameField:"email",passwordField:"password"},async(e,a,r)=>{let t=await O.findOne({email:e});return t?t.compararPassword(a)?r(null,t):r(null,!1,{message:"El password es incorrecto"}):r(null,!1,{message:"El email introducido, no esta registrado"})}));y.serializeUser((e,a)=>a(null,e._id));y.deserializeUser(async(e,a)=>{let r=await O.findById(e);return a(null,r)});var B=y;import ga from"http-errors";var va=new oa({mongoUrl:process.env.DATABASE,mongooseConnection:ta.connection});ca({path:"variables.env"});var S=da(ma(import.meta.url)),i=f();i.use(f.json());i.use(f.urlencoded({extended:!0}));i.use(pa());var ba=w.join(S,"/src/views/layouts"),ha=w.join(S,"/src/views"),ya=sa.create({defaulLayout:"main",layoutsDir:ba,helpers:_,handlebars:na(ia)});i.engine("handlebars",ya.engine);i.set("view engine","handlebars");i.set("views",ha);var wa=w.join(S,"/src/public"),Sa=w.join(S,"/src/views/styles");i.use(f.static(wa));i.use(f.static(Sa));i.use(ua());i.use(la({secret:process.env.SECRETO,key:process.env.KEY,resave:!1,saveUninitialized:!1,store:va}));i.use(B.initialize());i.use(B.session());i.use(fa());i.use((e,a,r)=>{a.locals.mensajes=e.flash(),r()});i.use("/",T);i.use((e,a,r)=>{r(ga(404,"Pagina no encontrada"))});i.use((e,a,r)=>{r.locals.mensaje=e.message;let t=e.status||500;r.locals.status=t,r.status(t),r.render("errores")});var Pa="0.0.0.0",Ea=process.env.PORT||8e3;i.listen(Ea,Pa,()=>{console.info(ra.blue("El servidor se ha iniciado correctamente"))});
